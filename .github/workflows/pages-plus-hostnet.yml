name: Pages preview → Hostnet deploy (clean)

on:
  push:
    branches: [ main ]      # pas aan als je default branch anders heet
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

env:
  REMOTE_PATH: "/httpdocs"  # Hostnet/Plesk documentroot

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Maak een schone deploy-map zonder rommel
      - name: Prepare clean deploy folder (exclude junk)
        run: |
          mkdir -p deploy
          rsync -av \
            --delete \
            --exclude='.git/' \
            --exclude='.github/' \
            --exclude='.gitignore' \
            --exclude='.gitattributes' \
            --exclude='README.md' \
            --exclude='LICENSE' \
            --exclude='INSTALL.txt' \
            --exclude='project.mobirise' \
            --exclude='publish-hashes.json' \
            --exclude='.vscode/' \
            --exclude='.idea/' \
            --exclude='node_modules/' \
            --exclude='**/*.psd' \
            --exclude='**/*.ai' \
            --exclude='**/*.kra' \
            --exclude='**/*.xcf' \
            --exclude='**/*.map' \
            ./ deploy/
          # Voeg extra excludes toe als je iets niet live nodig hebt
          # --exclude='history/'

      # Upload naar GitHub Pages (preview) — uit de schone map
      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: deploy

      # Bewaar dezelfde build voor Hostnet
      - name: Upload CI artifact
        uses: actions/upload-artifact@v4
        with:
          name: site-dist
          path: deploy

  deploy_pages:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  deploy_hostnet:
    needs: deploy_pages
    runs-on: ubuntu-latest
    environment: production     # ← approval vereist in Environment ‘production’
    steps:
      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: site-dist
          path: site

      - name: Upload via SFTP naar Hostnet
        uses: milanmk/actions-file-deployer@master
        with:
          remote-protocol: sftp
          remote-host: ${{ secrets.SFTP_HOST }}
          remote-user: ${{ secrets.SFTP_USER }}
          ssh-private-key: ${{ secrets.DEPLOY_PRIVATE_KEY }}  # of: remote-password
          local-path: "site"
          remote-path: ${{ env.REMOTE_PATH }}
          sync: "delta"
          ssh-options: "-o StrictHostKeyChecking=no"
